name: deploy-backend-ecs

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - "infra/ecs/taskdef.json"
      - ".github/workflows/backend-deploy.yml"

permissions:
  id-token: write
  contents: read

concurrency:
  group: backend-deploy-ecs-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPO: ${{ secrets.ECR_REPO }}
      ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
      ECS_SERVICE: ${{ secrets.ECS_SERVICE }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076

      - name: Build and push image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPO:$IMAGE_TAG"
          docker build -t "$IMAGE_URI" ./backend
          docker push "$IMAGE_URI"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Register new task definition (swap image) + deploy
        run: |
          set -euo pipefail

          echo "Getting current task definition..."
          CURRENT_TD_ARN=$(aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --query "services[0].taskDefinition" \
            --output text)
          
          if [ -z "$CURRENT_TD_ARN" ]; then
            echo "Error: Could not get current task definition ARN"
            exit 1
          fi
          
          echo "Current task definition: $CURRENT_TD_ARN"

          aws ecs describe-task-definition \
            --task-definition "$CURRENT_TD_ARN" \
            --query "taskDefinition" \
            --output json > /tmp/td.json

          python - <<'PY'
          import json, os
          td = json.load(open("/tmp/td.json"))
          img = os.environ["IMAGE_URI"]

          for c in td.get("containerDefinitions", []):
              if c.get("name") == "api":
                  c["image"] = img

          # Remove fields not allowed in RegisterTaskDefinition input
          # BUT preserve executionRoleArn and taskRoleArn (required for PassRole)
          for k in [
              "taskDefinitionArn","revision","status","requiresAttributes",
              "compatibilities","registeredAt","registeredBy","registeredAt",
              "deregisteredAt","placementConstraints"
          ]:
              td.pop(k, None)

          # Ensure executionRoleArn and taskRoleArn are preserved
          if "executionRoleArn" not in td:
              raise ValueError("executionRoleArn missing from task definition")
          if "taskRoleArn" not in td:
              raise ValueError("taskRoleArn missing from task definition")

          open("/tmp/td-new.json","w").write(json.dumps(td, indent=2))
          PY

          echo "Registering new task definition..."
          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file:///tmp/td-new.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)
          
          if [ -z "$NEW_TD_ARN" ]; then
            echo "Error: Failed to register new task definition"
            cat /tmp/td-new.json
            exit 1
          fi
          
          echo "New task definition: $NEW_TD_ARN"
          echo "Updating ECS service..."

          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "$NEW_TD_ARN"

          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"


