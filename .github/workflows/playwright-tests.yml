name: Playwright Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/playwright-tests.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/playwright-tests.yml'
  workflow_dispatch:

concurrency:
  group: playwright-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: playwright-chromium-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}

    - name: Setup backend
      uses: ./.github/actions/setup-backend

    - name: Setup frontend
      uses: ./.github/actions/setup-frontend

    - name: Event coverage QA
      run: python backend/scripts/qa_events_coverage.py
    
    - name: Install Playwright browsers
      working-directory: frontend
      run: |
        if [ "${{ steps.playwright-cache.outputs.cache-hit }}" = "true" ]; then
          npx playwright install-deps chromium
        else
          npx playwright install --with-deps chromium
        fi
    
    - name: Start backend server
      working-directory: backend
      env:
        NEO4J_URI: ${{ secrets.NEO4J_URI }}
        NEO4J_USER: ${{ secrets.NEO4J_USER }}
        NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        DEMO_MODE: "true"
        DEMO_GRAPH_ID: "demo"
        DEMO_ALLOW_WRITES: "false"
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
        sleep 5
        # Wait for backend to be ready
        for i in {1..30}; do
          if curl -f http://localhost:8000/ > /dev/null 2>&1; then
            echo "Backend is ready"
            break
          fi
          echo "Waiting for backend... ($i/30)"
          sleep 2
        done
    
    - name: Run Playwright tests
      working-directory: frontend
      env:
        NEXT_PUBLIC_API_URL: "http://localhost:8000"
        CI: "true"
      run: npx playwright test
    
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 30
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: frontend/test-results/
        retention-days: 30

  create-agent-feed-issue:
    needs: test
    if: failure() && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Create agent-feed issue for Playwright failure
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          REF: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          CREATED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          DEDUPE_KEY="playwright:${RUN_ID}"

          # Avoid duplicates if workflow is retried
          EXISTING=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${REPO}/issues?labels=agent-fix&state=open&per_page=100")
          if echo "$EXISTING" | jq -e --arg k "$DEDUPE_KEY" '.[]?.body | test($k)' >/dev/null 2>&1; then
            echo "Existing open issue with dedupe_key=$DEDUPE_KEY found, skipping"
            exit 0
          fi

          FEED_JSON=$(jq -n \
            --arg run_url "$RUN_URL" \
            --arg branch "$REF" \
            --arg commit "$SHA" \
            --arg dedupe "$DEDUPE_KEY" \
            --arg created "$CREATED_AT" \
            '{agent_feed: {type: "playwright_failure", source: "playwright", dedupe_key: $dedupe, status: "queued", severity: "high", priority: "p1", owner_lane: "frontend", payload: {run_url: $run_url, branch: $branch, commit: $commit, summary: "Playwright tests failed. See run for report and test-results artifact."}, created_at: $created}}')

          {
            echo '<!-- agent_feed:start -->'
            echo '```json'
            echo "$FEED_JSON"
            echo '```'
            echo '<!-- agent_feed:end -->'
            echo
            echo "**Run:** [View workflow run](${RUN_URL})"
            echo "**Branch:** ${REF} | **Commit:** ${SHA}"
            echo 'Artifacts: `playwright-report`, `test-results`.'
            echo 'Agent: see `.github/AGENT_FEED.md`. Fix failing tests and re-run.'
          } > /tmp/body.txt

          PAYLOAD=$(jq -n --arg title "[Playwright] E2E tests failed" --rawfile body /tmp/body.txt '{title: $title, body: $body, labels: ["agent-fix", "playwright", "automated"]}')
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "$PAYLOAD" \
            "https://api.github.com/repos/${REPO}/issues"



